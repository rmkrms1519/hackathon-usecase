name: Deploy to GKE

on:
  workflow_run:
    workflows: ["Docker Build and Push"]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: choice
        options: [dev, staging, prod]

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GKE_CLUSTER: hackathon-gke-dev
  GKE_REGION: asia-south1
  GAR_REGION: asia-south1
  GAR_REPO: hackathon-repo-dev

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    name: Deploy to GKE
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    steps:
      - uses: actions/checkout@v4
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - uses: google-github-actions/setup-gcloud@v2
        with:
          install_components: 'gke-gcloud-auth-plugin'
      - uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ env.GKE_CLUSTER }}
          location: ${{ env.GKE_REGION }}
      - name: Create Namespace
        run: kubectl apply -f k8s/deployments/namespace.yaml
      - name: Update Image Tags
        run: |
          IMAGE_PREFIX="${{ env.GAR_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.GAR_REPO }}"
          TAG="${{ github.sha }}"
          sed -i "s|REGION-docker.pkg.dev/PROJECT_ID/REPO_NAME|${IMAGE_PREFIX}|g" k8s/deployments/*.yaml
          sed -i "s|:latest|:${TAG}|g" k8s/deployments/*.yaml
      - name: Deploy Services
        run: |
          kubectl apply -f k8s/deployments/
          kubectl apply -f k8s/services/
          kubectl apply -f k8s/ingress/
      - name: Wait for Rollout
        run: |
          kubectl rollout status deployment/patient-service -n healthcare --timeout=300s
          kubectl rollout status deployment/application-service -n healthcare --timeout=300s
          kubectl rollout status deployment/order-service -n healthcare --timeout=300s
      - name: Verify
        run: |
          echo "=== Deployments ==="
          kubectl get deployments -n healthcare
          echo "=== Pods ==="
          kubectl get pods -n healthcare
          echo "=== Services ==="
          kubectl get services -n healthcare
          echo "=== Ingress ==="
          kubectl get ingress -n healthcare

  deploy-monitoring:
    name: Deploy Monitoring
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - uses: actions/checkout@v4
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - uses: google-github-actions/setup-gcloud@v2
        with:
          install_components: 'gke-gcloud-auth-plugin'
      - uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ env.GKE_CLUSTER }}
          location: ${{ env.GKE_REGION }}
      - name: Deploy Prometheus and Grafana
        run: kubectl apply -f k8s/monitoring/
